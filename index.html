<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modern Music Player</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jschardet/3.0.0/jschardet.min.js"></script>
  <style>
    :root {
      --primary: #8A2BE2;
      --secondary: #BA55D3;
      --accent: #FF6B6B;
      --dark: #1A1A1A;
      --light: #F8F8FF;
      --transition-speed: 0.4s;
      --radius-lg: 24px;
      --radius-md: 16px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(to right, #406187, #2c88bd);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--light);
      transition: background var(--transition-speed) ease;
      overflow-x: hidden;
    }

    /* Background with animation - 使用will-change优化性能 */
    .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url(https://api.dujin.org/bing/1920.php) no-repeat center center fixed;
      background-size: cover;
      filter: blur(12px);
      z-index: -1;
      transition: background-image var(--transition-speed) ease;
      animation: backgroundPulse 15s infinite alternate;
      will-change: filter;
    }

    @keyframes backgroundPulse {
      0% {
        filter: blur(12px) brightness(0.8);
      }
      100% {
        filter: blur(12px) brightness(1);
      }
    }

    /* Main container */
    .player-container {
      width: 90%;
      max-width: 420px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px); /* Safari支持 */
      border-radius: var(--radius-lg);
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255,255,255,0.1);
      transition: all var(--transition-speed) ease;
    }

    .player-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      opacity: 0.15;
      z-index: -1;
    }

    /* Mini-player mode */
    .player-container.mini-mode {
      max-width: 300px;
      transform: scale(0.85);
    }
    
    .mini-mode .cover {
      margin: 10px;
    }
    
    .mini-mode .visualization,
    .mini-mode .progress-container,
    .mini-mode .song-artist {
      display: none;
    }
    
    .mini-mode .controls {
      padding: 10px;
    }

    /* Glass morphism effect on hover */
    .player-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 16px 48px rgba(0,0,0,0.4);
      background: rgba(255, 255, 255, 0.1);
    }

    /* Album cover */
    .cover {
      position: relative;
      margin: 20px;
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
      cursor: pointer;
    }

    .cover:hover {
      transform: scale(1.02);
      box-shadow: 0 12px 30px rgba(0,0,0,0.5);
    }

    .cover:active {
      transform: scale(0.98);
    }

    .cover img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      display: block;
      transition: filter var(--transition-speed) ease;
    }

    .cover img:hover {
      filter: brightness(1.1);
    }

    #coverPlaceholder {
      background: linear-gradient(45deg, #37529d, #55d3b6);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      aspect-ratio: 1;
      text-align: center;
      padding: 20px;
    }

    /* Controls section */
    .controls {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      background: rgba(0,0,0,0.2);
    }

    /* Playback controls */
    .playback-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .control-btn {
      background: none;
      border: none;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      color: white;
      cursor: pointer;
      transition: all var(--transition-speed) ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .control-btn:hover {
      background: var(--primary);
      transform: scale(1.1);
      box-shadow: 0 0 15px rgba(138, 43, 226, 0.6);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .control-btn-small {
      width: 40px;
      height: 40px;
      font-size: 16px;
    }

    /* Progress bar */
    .progress-container {
      flex-grow: 1;
      margin: 10px 0;
      position: relative;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 5px;
      color: rgba(255,255,255,0.7);
    }

    .progress-container input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      background: transparent;
      cursor: pointer;
    }

    .progress-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      margin-top: -5px;
      border: none;
      box-shadow: 0 0 10px rgba(138, 43, 226, 0.8);
      transition: all 0.2s ease;
    }

    .progress-container input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .progress-container input[type="range"]::-webkit-slider-runnable-track {
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
    }

    /* Volume control */
    .volume-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .volume-icon {
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    .volume-slider {
      width: 80px;
    }

    .volume-slider input[type="range"] {
      width: 100%;
      -webkit-appearance: none;
      background: transparent;
      cursor: pointer;
    }

    .volume-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      margin-top: -4px;
      border: none;
    }

    .volume-slider input[type="range"]::-webkit-slider-runnable-track {
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
    }

    /* Visualization */
    .visualization {
      height: 60px;
      margin: 0 20px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      padding-bottom: 10px;
    }

    .bar {
      width: 6px;
      background: var(--primary);
      border-radius: 3px;
      transition: height 0.2s ease;
      will-change: height, background-color;
    }

    /* Lyric display */
    .lyric-overlay {

      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      overflow: hidden;
      padding: 20px 0;
      }

    .lyric-content {
      width: 90%;
      max-width: 800px;
      max-height: 70vh;
      height: auto;
      overflow-y: auto;
      padding: 0 30px;
      scroll-behavior: smooth;
      color: white;
      font-size: 18px;
      line-height: 1.6;
    }

    .lyric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: rgb(185 185 185 / 80%);
      padding: 15px;
      margin-bottom: 20px;
      border-radius: var(--radius-sm);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .lyric-title {
      font-size: 20px;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
    }

    .close-lyrics {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .close-lyrics:hover {
      transform: scale(1.1);
      color: var(--accent);
    }

    .lyric-line {
      padding: 15px;
      margin: 5px 0;
      border-radius: var(--radius-sm);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .lyric-line:hover {
      background: rgba(255,255,255,0.1);
    }

    .lyric-line.active {
      color: var(--primary);
      font-weight: bold;
      background: rgba(138, 43, 226, 0.1);
      transform: scale(1.05);
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary);
    }

    /* Now playing info */
    .now-playing {
      padding: 15px 20px;
      text-align: center;
      background: rgba(0,0,0,0.2);
    }

    .song-title {
      font-size: 18px;
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      margin: 0 auto;
    }

    /* 添加歌曲标题滚动效果 */
    .song-title.scrolling {
      animation: scrollText 10s linear infinite;
      display: inline-block;
      padding-right: 10px;
    }

    @keyframes scrollText {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    .song-artist {
      font-size: 14px;
      opacity: 0.8;
      margin-top: 5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* New file buttons toolbar */
    .file-toolbar {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .file-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      position: relative;
    }

    .file-btn:hover {
      background: var(--primary);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .file-btn:active {
      transform: translateY(0);
    }

    .file-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    /* Tooltip for file buttons */
    .file-btn::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .file-btn:hover::after {
      visibility: visible;
      opacity: 1;
    }

    /* Settings button and panel */
    .settings-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 10;
    }

    .settings-btn:hover {
      background: var(--secondary);
      transform: rotate(30deg);
    }

    .settings-panel {
      position: absolute;
      top: 55px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: var(--radius-md);
      padding: 15px;
      width: 220px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      z-index: 11;
      transform-origin: top left;
      transform: scale(0.9);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .settings-panel.active {
      transform: scale(1);
      opacity: 1;
      visibility: visible;
    }

    .settings-panel h3 {
      margin-bottom: 12px;
      font-size: 16px;
      color: var(--light);
      opacity: 0.9;
    }

    .settings-option {
      margin-bottom: 12px;
    }

    .settings-option label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: var(--light);
      opacity: 0.8;
    }

    /* Notification */
    .notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      transition: all 0.3s ease;
      opacity: 0;
      z-index: 1000;
    }

    .notification.active {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Button to toggle file toolbar visibility on mobile */
    .toggle-toolbar {
      display: none;
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      font-size: 18px;
      cursor: pointer;
      z-index: 10;
    }

    /* Refresh background button */
    .refresh-background {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .refresh-background:hover {
      background: var(--accent);
      transform: rotate(180deg);
    }

    /* Date and time display */
    .date-time {
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    /* 新增重复播放按钮样式 */
    .repeat-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .repeat-btn:hover {
      background: var(--primary);
      transform: scale(1.1);
    }
    
    .repeat-btn.active {
      color: var(--accent);
    }
    
    .repeat-btn.repeat-one::after {
      content: "1";
      position: absolute;
      font-size: 9px;
      bottom: 8px;
      right: 10px;
      color: var(--accent);
    }

    /* 添加新功能按钮样式 */
    .feature-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      color: white;
      border: none;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      position: relative;
    }

    .feature-btn:hover {
      background: var(--primary);
      transform: scale(1.1);
    }

    .feature-btn.active {
      color: var(--accent);
    }

    /* 睡眠定时器弹窗 */
    .sleep-timer-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1100;
    }

    .sleep-timer-content {
      background: rgba(30, 30, 30, 0.9);
      width: 90%;
      max-width: 320px;
      padding: 20px;
      border-radius: var(--radius-md);
      text-align: center;
    }

    .sleep-timer-content h3 {
      margin-bottom: 15px;
      color: white;
    }

    .sleep-timer-options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .sleep-option {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sleep-option:hover, .sleep-option.active {
      background: var(--primary);
    }

    .timer-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .timer-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 8px 20px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .timer-btn:hover {
      background: var(--primary);
    }

    .timer-cancel {
      background: rgba(255, 107, 107, 0.2);
    }

    .timer-cancel:hover {
      background: var(--accent);
    }

    .timer-display {
      font-size: 24px;
      color: white;
      margin: 15px 0;
    }

    /* 播放列表样式 */
    .playlist-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1100;
    }

    .playlist-content {
      background: rgba(30, 30, 30, 0.9);
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      padding: 20px;
      border-radius: var(--radius-md);
      overflow-y: auto;
    }

    .playlist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .playlist-header h3 {
      color: white;
      font-size: 18px;
    }

    .close-playlist {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    .playlist-items {
      list-style: none;
    }

    .playlist-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,0.05);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .playlist-item:hover {
      background: rgba(255,255,255,0.1);
    }

    .playlist-item.active {
      background: rgba(138, 43, 226, 0.2);
    }

    .playlist-item-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
    }

    .playlist-controls {
      display: flex;
      gap: 10px;
    }

    .playlist-btn {
      background: none;
      border: none;
      color: white;
      font-size: 14px;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.2s ease;
    }

    .playlist-btn:hover {
      opacity: 1;
      color: var(--accent);
    }

    .add-to-playlist {
      display: flex;
      justify-content: center;
      margin-top: 15px;
    }

    .add-playlist-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s ease;
    }

    .add-playlist-btn:hover {
      background: var(--primary);
    }

    /* 全屏模式 */
    .fullscreen-mode {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2000;
      background: rgba(0,0,0,0.85);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    .fullscreen-cover {
      width: 70vmin;
      height: 70vmin;
      max-width: 500px;
      max-height: 500px;
      border-radius: 10px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      overflow: hidden;
      animation: float 6s ease-in-out infinite;
    }

    .fullscreen-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
      100% { transform: translateY(0px); }
    }

    .fullscreen-info {
      margin-top: 30px;
      text-align: center;
      color: white;
    }

    .fullscreen-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .fullscreen-artist {
      font-size: 18px;
      opacity: 0.8;
    }

    .fullscreen-controls {
      margin-top: 30px;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .fullscreen-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .fullscreen-btn:hover {
      background: var(--primary);
      transform: scale(1.1);
    }

    .fullscreen-btn.main-btn {
      width: 70px;
      height: 70px;
      font-size: 30px;
    }

    .fullscreen-progress {
      width: 80%;
      max-width: 600px;
      margin-top: 30px;
    }

    .fullscreen-progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      position: relative;
      cursor: pointer;
    }

    .fullscreen-progress-current {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--primary);
      border-radius: 3px;
      width: 0%;
    }

    .fullscreen-times {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 14px;
      color: rgba(255,255,255,0.7);
    }

    .fullscreen-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.2s ease;
    }

    .fullscreen-close:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    /* 增强版可视化 */
    .enhanced-viz {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.2;
      pointer-events: none;
    }

    .enhanced-viz canvas {
      width: 100%;
      height: 100%;
    }

    /* 深色/浅色模式切换 */
    body.light-mode {
      background: linear-gradient(to right, #e0e0e0, #f5f5f5);
      color: var(--dark);
    }

    .light-mode .player-container {
      background: rgba(255, 255, 255, 0.7);
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }

    .light-mode .controls,
    .light-mode .now-playing {
      background: rgba(200,200,200,0.3);
    }

    .light-mode .song-title,
    .light-mode .song-artist {
      color: var(--dark);
    }

    .light-mode .control-btn,
    .light-mode .repeat-btn,
    .light-mode .feature-btn {
      background: rgba(0,0,0,0.1);
      color: var(--dark);
    }

    .light-mode .volume-icon {
      color: var(--dark);
    }

    .light-mode .progress-container input[type="range"]::-webkit-slider-runnable-track {
      background: rgba(0,0,0,0.2);
    }

    /* 自适应媒体查询优化 */
    @media (max-width: 768px) {
      .player-container {
        width: 95%;
        max-width: 500px;
      }
      
      .control-btn {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      
      .control-btn-small {
        width: 36px;
        height: 36px;
        font-size: 14px;
      }
      
      .lyric-content {
        font-size: 16px;
      }
      
      .volume-slider {
        width: 60px;
      }

      .fullscreen-cover {
        width: 80vmin;
        height: 80vmin;
      }
    }

    @media (max-width: 480px) {
      .player-container {
        width: 98%;
        border-radius: var(--radius-md);
      }
      
      .cover {
        margin: 15px;
      }
      
      .control-btn {
        width: 46px;
        height: 46px;
        font-size: 18px;
      }
      
      .control-btn-small,
      .repeat-btn,
      .feature-btn {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }
      
      .toggle-toolbar {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .file-toolbar {
        transition: all 0.3s ease;
        opacity: 0.6;
      }
      
      .file-toolbar:hover {
        opacity: 1;
      }
      
      .lyric-content {
        font-size: 14px;
        width: 95%;
      }
      
      .volume-slider {
        width: 50px;
      }

      .file-btn::after {
        display: none;
      }

      .song-title {
        font-size: 16px;
      }

      .song-artist {
        font-size: 12px;
      }

      .fullscreen-title {
        font-size: 20px;
      }

      .fullscreen-artist {
        font-size: 16px;
      }

      .fullscreen-controls {
        gap: 10px;
      }

      .fullscreen-btn {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }

      .fullscreen-btn.main-btn {
        width: 60px;
        height: 60px;
        font-size: 24px;
      }
    }
    
    /* Fade in animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .player-container {
      animation: fadeIn 0.6s ease-out;
    }
  </style>
</head>
<body>
  <!-- Background layer -->
  <div class="background" id="background"></div>
  
  <div class="player-container" id="playerContainer">
    <!-- Settings button -->
    <button class="settings-btn" id="settingsBtn" title="设置">
      <i class="fas fa-cog"></i>
    </button>
    
    <!-- Settings panel -->
    <div class="settings-panel" id="settingsPanel">
      <h3>播放器设置</h3>
      
      <div class="settings-option">
        <label for="themeSelect">主题色:</label>
        <select id="themeSelect" style="width: 100%; padding: 5px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px;">
          <option value="purple">紫色</option>
          <option value="blue">蓝色</option>
          <option value="green">绿色</option>
          <option value="pink">粉色</option>
        </select>
      </div>
      
      <div class="settings-option">
        <label for="autoplayCheck">自动播放:</label>
        <input type="checkbox" id="autoplayCheck">
      </div>
      
      <div class="settings-option">
        <label for="visualizerCheck">音频可视化:</label>
        <input type="checkbox" id="visualizerCheck" checked>
      </div>
      
      <div class="settings-option">
        <label for="darkModeCheck">深色模式:</label>
        <input type="checkbox" id="darkModeCheck" checked>
      </div>
      
      <div class="settings-option">
        <label for="titleScrollCheck">标题滚动:</label>
        <input type="checkbox" id="titleScrollCheck" checked>
      </div>
      
      <div class="settings-option">
        <button id="refreshBackground" style="width: 100%; padding: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer;">
          刷新背景图片
        </button>
      </div>
      
      <div class="settings-option">
        <button id="toggleMiniPlayer" style="width: 100%; padding: 6px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer;">
          迷你播放器
        </button>
      </div>
      
      <div class="settings-option">
        <button id="saveSettings" style="width: 100%; padding: 6px; background: rgba(138,43,226,0.5); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer;">
          保存设置
        </button>
      </div>
    </div>

    <!-- New file input toolbar with icons -->
    <div class="file-toolbar" id="fileToolbar">
      <div class="file-btn" data-tooltip="选择音乐">
        <i class="fas fa-music"></i>
        <input type="file" class="file-input" id="musicFile" accept="audio/*">
      </div>
      
      <div class="file-btn" data-tooltip="选择封面">
        <i class="fas fa-image"></i>
        <input type="file" class="file-input" id="coverFile" accept="image/*">
      </div>
      
      <div class="file-btn" data-tooltip="选择歌词">
        <i class="fas fa-file-alt"></i>
        <input type="file" class="file-input" id="lyricFile" accept=".lrc,.txt">
      </div>
      
      <div class="file-btn" data-tooltip="播放列表" id="playlistBtn">
        <i class="fas fa-list"></i>
      </div>
    </div>
    
    <div class="cover" id="cover" title="点击显示歌词">
      <img id="coverImg" src="" alt="封面预览" style="display:none;">
      <div id="coverPlaceholder" style="
          width: 390px;
          height: 290px;
      ">
        <i class="fas fa-music" style="font-size: 32px; margin-bottom: 10px;"></i><br>
        点击显示歌词
      </div>
    </div>
    
    <div class="now-playing">
      <div class="song-title" id="songTitle">未加载音乐</div>
      <div class="song-artist" id="songArtist">点击右上角按钮选择文件</div>
    </div>
    
    <div class="visualization" id="visualization">
      <!-- Bars will be dynamically generated -->
    </div>
    
    <div class="progress-container">
      <input type="range" id="progressSlider" value="0" min="0" max="100">
      <div class="progress-info">
        <span id="currentTime">0:00</span>
        <span id="totalTime">0:00</span>
      </div>
    </div>
    
    <div class="controls">
      <div class="playback-controls">
        <button class="control-btn control-btn-small" id="prevBtn"><i class="fas fa-step-backward"></i></button>
        <button class="control-btn" id="playPauseBtn"><i class="fas fa-play"></i></button>
        <button class="control-btn control-btn-small" id="nextBtn"><i class="fas fa-step-forward"></i></button>
        <!-- 重复播放按钮 -->
        <button class="repeat-btn" id="repeatBtn" title="重复播放模式"><i class="fas fa-repeat"></i></button>
        <!-- 睡眠定时按钮 -->
        <button class="feature-btn" id="sleepBtn" title="睡眠定时"><i class="fas fa-moon"></i></button>
        <!-- 全屏模式按钮 -->
        <button class="feature-btn" id="fullscreenBtn" title="全屏模式"><i class="fas fa-expand"></i></button>
      </div>
      
      <!-- Volume controls -->
      <div class="volume-container">
        <div class="volume-icon">
          <i class="fas fa-volume-up" id="volumeIcon"></i>
        </div>
        <div class="volume-slider">
          <input type="range" id="volumeSlider" min="0" max="100" value="80" style="
                width: 40px;
            ">
        </div>
      </div>
    </div>
    
    <!-- Mobile toggle toolbar button -->
    <button class="toggle-toolbar" id="toggleToolbar">
      <i class="fas fa-ellipsis-h"></i>
    </button>
    <!-- Date and time display -->
    <div class="date-time" id="dateTime">提示:点击图片显示歌词</div>
    
    <!-- Hidden audio player -->
    <audio id="audioPlayer" controls style="display:none;"></audio>
    
    <!-- Enhanced visualization container -->
    <div class="enhanced-viz" id="enhancedViz">
      <canvas id="vizCanvas"></canvas>
    </div>
  </div>

  <!-- Lyric display overlay -->
  <div class="lyric-overlay" id="lyricOverlay">
    <div class="lyric-content" id="lyricContent">
      <div class="lyric-header">
        <div class="lyric-title" id="lyricTitle">歌词</div>
        <button class="close-lyrics" id="closeLyrics"><i class="fas fa-times"></i></button>
      </div>
      <!-- Lyrics will be dynamically inserted -->
    </div>
  </div>

  <!-- Sleep timer modal -->
  <div class="sleep-timer-modal" id="sleepTimerModal">
    <div class="sleep-timer-content">
      <h3>设置睡眠定时</h3>
      <div class="sleep-timer-options">
        <button class="sleep-option" data-minutes="15">15分钟</button>
        <button class="sleep-option" data-minutes="30">30分钟</button>
        <button class="sleep-option" data-minutes="45">45分钟</button>
        <button class="sleep-option" data-minutes="60">60分钟</button>
        <button class="sleep-option" data-minutes="90">90分钟</button>
      </div>
      <div class="timer-display" id="timerDisplay">00:00:00</div>
      <div class="timer-buttons">
        <button class="timer-btn timer-cancel" id="cancelSleepTimer">取消</button>
        <button class="timer-btn" id="confirmSleepTimer">确定</button>
      </div>
    </div>
  </div>

  <!-- Playlist modal -->
  <div class="playlist-modal" id="playlistModal">
    <div class="playlist-content">
      <div class="playlist-header">
        <h3>播放列表</h3>
        <button class="close-playlist" id="closePlaylist"><i class="fas fa-times"></i></button>
      </div>
      <ul class="playlist-items" id="playlistItems">
        <!-- Playlist items will be dynamically inserted -->
      </ul>
      <div class="add-to-playlist">
        <button class="add-playlist-btn" id="addPlaylistBtn">
          <i class="fas fa-plus"></i> 添加音乐
        </button>
      </div>
    </div>
  </div>

  <!-- Fullscreen mode -->
  <div class="fullscreen-mode" id="fullscreenMode">
    <button class="fullscreen-close" id="closeFullscreen"><i class="fas fa-times"></i></button>
    <div class="fullscreen-cover">
      <img id="fullscreenCoverImg" src="" alt="封面">
    </div>
    <div class="fullscreen-info">
      <div class="fullscreen-title" id="fullscreenTitle">未加载音乐</div>
      <div class="fullscreen-artist" id="fullscreenArtist">未知艺术家</div>
    </div>
    <div class="fullscreen-controls">
      <button class="fullscreen-btn" id="fullscreenPrevBtn"><i class="fas fa-step-backward"></i></button>
      <button class="fullscreen-btn main-btn" id="fullscreenPlayBtn"><i class="fas fa-play"></i></button>
      <button class="fullscreen-btn" id="fullscreenNextBtn"><i class="fas fa-step-forward"></i></button>
    </div>
    <div class="fullscreen-progress">
      <div class="fullscreen-progress-bar" id="fullscreenProgressBar">
        <div class="fullscreen-progress-current" id="fullscreenProgressCurrent"></div>
      </div>
      <div class="fullscreen-times">
        <span id="fullscreenCurrentTime">0:00</span>
        <span id="fullscreenTotalTime">0:00</span>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification"></div>

  <script>
    // 主要DOM元素
    const musicInput = document.getElementById("musicFile");
    const coverInput = document.getElementById("coverFile");
    const lyricInput = document.getElementById("lyricFile");
    const audioPlayer = document.getElementById("audioPlayer");
    const cover = document.getElementById("cover");
    const coverImg = document.getElementById("coverImg");
    const coverPlaceholder = document.getElementById("coverPlaceholder");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const repeatBtn = document.getElementById("repeatBtn");
    const sleepBtn = document.getElementById("sleepBtn");
    const fullscreenBtn = document.getElementById("fullscreenBtn");
    const progressSlider = document.getElementById("progressSlider");
    const lyricOverlay = document.getElementById("lyricOverlay");
    const lyricContent = document.getElementById("lyricContent");
    const closeLyrics = document.getElementById("closeLyrics");
    const backgroundDiv = document.getElementById("background");
    const currentTimeDisplay = document.getElementById("currentTime");
    const totalTimeDisplay = document.getElementById("totalTime");
    const songTitle = document.getElementById("songTitle");
    const songArtist = document.getElementById("songArtist");
    const volumeSlider = document.getElementById("volumeSlider");
    const volumeIcon = document.getElementById("volumeIcon");
    const visualization = document.getElementById("visualization");
    const lyricTitle = document.getElementById("lyricTitle");
    const settingsBtn = document.getElementById("settingsBtn");
    const settingsPanel = document.getElementById("settingsPanel");
    const notification = document.getElementById("notification");
    const themeSelect = document.getElementById("themeSelect");
    const autoplayCheck = document.getElementById("autoplayCheck");
    const visualizerCheck = document.getElementById("visualizerCheck");
    const darkModeCheck = document.getElementById("darkModeCheck");
    const titleScrollCheck = document.getElementById("titleScrollCheck");
    const toggleToolbar = document.getElementById("toggleToolbar");
    const fileToolbar = document.getElementById("fileToolbar");
    const refreshBackground = document.getElementById("refreshBackground");
    const toggleMiniPlayer = document.getElementById("toggleMiniPlayer");
    const saveSettings = document.getElementById("saveSettings");
    const playerContainer = document.getElementById("playerContainer");
    const dateTime = document.getElementById("dateTime");
    const playlistBtn = document.getElementById("playlistBtn");
    const playlistModal = document.getElementById("playlistModal");
    const closePlaylist = document.getElementById("closePlaylist");
    const playlistItems = document.getElementById("playlistItems");
    const addPlaylistBtn = document.getElementById("addPlaylistBtn");
    const sleepTimerModal = document.getElementById("sleepTimerModal");
    const sleepOptions = document.querySelectorAll(".sleep-option");
    const cancelSleepTimer = document.getElementById("cancelSleepTimer");
    const confirmSleepTimer = document.getElementById("confirmSleepTimer");
    const timerDisplay = document.getElementById("timerDisplay");
    const fullscreenMode = document.getElementById("fullscreenMode");
    const closeFullscreen = document.getElementById("closeFullscreen");
    const fullscreenCoverImg = document.getElementById("fullscreenCoverImg");
    const fullscreenTitle = document.getElementById("fullscreenTitle");
    const fullscreenArtist = document.getElementById("fullscreenArtist");
    const fullscreenPlayBtn = document.getElementById("fullscreenPlayBtn");
    const fullscreenPrevBtn = document.getElementById("fullscreenPrevBtn");
    const fullscreenNextBtn = document.getElementById("fullscreenNextBtn");
    const fullscreenProgressBar = document.getElementById("fullscreenProgressBar");
    const fullscreenProgressCurrent = document.getElementById("fullscreenProgressCurrent");
    const fullscreenCurrentTime = document.getElementById("fullscreenCurrentTime");
    const fullscreenTotalTime = document.getElementById("fullscreenTotalTime");
    const enhancedViz = document.getElementById("enhancedViz");
    const vizCanvas = document.getElementById("vizCanvas");

    // 全局变量
    let lyrics = []; // {time, text}
    let autoScroll = true;
    let autoScrollTimeout = null;
    let currentPlaylist = []; // 播放列表
    let currentTrackIndex = 0;
    let audioContext;
    let analyser;
    let source;
    let animationFrame;
    let bingBackgroundTimestamp = Date.now(); // Bing图片缓存时间戳
    let repeatMode = 0; // 重复播放模式 (0: 不重复, 1: 单曲循环, 2: 列表循环)
    let sleepTimerMinutes = 0; // 睡眠定时器分钟数
    let sleepTimerInterval = null; // 睡眠定时器间隔
    let sleepTimerEnd = null; // 睡眠定时器结束时间
    let isFullscreen = false; // 是否全屏模式
    let canvasContext; // 增强可视化画布上下文
    let marqueeInterval; // 歌曲标题滚动间隔
    
    // 状态变量
    const state = {
      isDarkMode: true,
      isMiniMode: false,
      isTitleScrolling: true,
      volume: 0.8,
      theme: 'purple',
      autoplay: false,
      visualizer: true
    };
    
    // 加载保存的设置
    loadSettings();
    applySettings();
    
    // 设置当前日期时间
    updateDateTime();
    
    // 定时更新日期时间
    setInterval(updateDateTime, 1000);
    
    // 更新日期时间显示
    function updateDateTime() {
      const now = new Date();
      const year = now.getFullYear();
      const month = (now.getMonth() + 1).toString().padStart(2, '0');
      const day = now.getDate().toString().padStart(2, '0');
      const hours = now.getHours().toString().padStart(2, '0');
      const minutes = now.getMinutes().toString().padStart(2, '0');
      dateTime.textContent = `${year}-${month}-${day} ${hours}:${minutes} | fxlqwq`;
    }
    
    // 加载保存的设置
    function loadSettings() {
      try {
        const savedSettings = localStorage.getItem('musicPlayerSettings');
        if (savedSettings) {
          const parsed = JSON.parse(savedSettings);
          Object.assign(state, parsed);
        }
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    }
    
    // 保存设置
    function saveCurrentSettings() {
      state.isDarkMode = darkModeCheck.checked;
      state.isTitleScrolling = titleScrollCheck.checked;
      state.theme = themeSelect.value;
      state.autoplay = autoplayCheck.checked;
      state.visualizer = visualizerCheck.checked;
      
      try {
        localStorage.setItem('musicPlayerSettings', JSON.stringify(state));
        showNotification('设置已保存');
      } catch (e) {
        showNotification('设置保存失败', 3000);
      }
    }
    
    // 应用设置
    function applySettings() {
      // 设置复选框状态
      darkModeCheck.checked = state.isDarkMode;
      titleScrollCheck.checked = state.isTitleScrolling;
      autoplayCheck.checked = state.autoplay;
      visualizerCheck.checked = state.visualizer;
      
      // 设置主题
      themeSelect.value = state.theme;
      changeTheme(state.theme);
      
      // 设置深色/浅色模式
      toggleDarkMode(state.isDarkMode);
      
      // 设置音量
      audioPlayer.volume = state.volume;
      volumeSlider.value = state.volume * 100;
      
      // 设置迷你模式
      if (state.isMiniMode) {
        playerContainer.classList.add('mini-mode');
      } else {
        playerContainer.classList.remove('mini-mode');
      }
      
      // 设置可视化
      visualization.style.display = state.visualizer ? 'flex' : 'none';
      
      // 如果有标题，检查滚动
      if (state.isTitleScrolling && songTitle.textContent !== '未加载音乐') {
        checkTitleScroll();
      }
    }
    
    // 设置背景
    function setDefaultBackground() {
      backgroundDiv.style.backgroundImage = `url(https://api.dujin.org/bing/1920.php?t=${bingBackgroundTimestamp})`;
    }
    
    // 刷新背景
    function refreshBingBackground() {
      bingBackgroundTimestamp = Date.now();
      setDefaultBackground();
      showNotification("背景图片已更新");
    }
    
    // 添加刷新背景按钮事件
    refreshBackground.addEventListener('click', refreshBingBackground);
    
    // 初始化背景
    setDefaultBackground();
    
    // 显示通知
    function showNotification(message, duration = 3000) {
      // 清除之前的计时器
      if (notification.timeoutId) {
        clearTimeout(notification.timeoutId);
      }
      
      notification.textContent = message;
      notification.classList.add('active');
      
      notification.timeoutId = setTimeout(() => {
        notification.classList.remove('active');
      }, duration);
    }
    
    // 设置按钮点击
    settingsBtn.addEventListener('click', () => {
      settingsPanel.classList.toggle('active');
    });
    
    // 点击外部关闭设置面板
    document.addEventListener('click', (e) => {
      if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) {
        settingsPanel.classList.remove('active');
      }
    });
    
    // 主题更改
    themeSelect.addEventListener('change', () => {
      changeTheme(themeSelect.value);
      showNotification('主题已更新');
    });
    
    // 更改主题函数
    function changeTheme(theme) {
      const root = document.documentElement;
      
      switch(theme) {
        case 'blue':
          root.style.setProperty('--primary', '#4169E1');
          root.style.setProperty('--secondary', '#00BFFF');
          break;
        case 'green':
          root.style.setProperty('--primary', '#2E8B57');
          root.style.setProperty('--secondary', '#3CB371');
          break;
        case 'pink':
          root.style.setProperty('--primary', '#FF1493');
          root.style.setProperty('--secondary', '#FF69B4');
          break;
        case 'purple':
        default:
          root.style.setProperty('--primary', '#8A2BE2');
          root.style.setProperty('--secondary', '#BA55D3');
          break;
      }
    }
    
    // 深色模式切换
    darkModeCheck.addEventListener('change', () => {
      toggleDarkMode(darkModeCheck.checked);
    });
    
    // 切换深色/浅色模式
    function toggleDarkMode(isDark) {
      if (isDark) {
        document.body.classList.remove('light-mode');
      } else {
        document.body.classList.add('light-mode');
      }
    }
    
    // 可视化切换
    visualizerCheck.addEventListener('change', () => {
      visualization.style.display = visualizerCheck.checked ? 'flex' : 'none';
    });
    
    // 标题滚动切换
    titleScrollCheck.addEventListener('change', () => {
      if (titleScrollCheck.checked) {
        checkTitleScroll();
      } else {
        songTitle.classList.remove('scrolling');
        clearInterval(marqueeInterval);
      }
    });
    
    // 保存设置按钮
    saveSettings.addEventListener('click', saveCurrentSettings);
    
    // 切换迷你播放器
    toggleMiniPlayer.addEventListener('click', () => {
      playerContainer.classList.toggle('mini-mode');
      state.isMiniMode = playerContainer.classList.contains('mini-mode');
      showNotification(state.isMiniMode ? '已切换到迷你模式' : '已退出迷你模式');
    });
    
    // 移动端工具栏切换
    toggleToolbar.addEventListener('click', () => {
      fileToolbar.style.opacity = fileToolbar.style.opacity === '1' ? '0.6' : '1';
    });
    
    // 检查歌曲标题是否需要滚动
    function checkTitleScroll() {
      // 清除之前的滚动
      clearInterval(marqueeInterval);
      songTitle.classList.remove('scrolling');
      
      // 如果内容过长，添加滚动
      if (titleScrollCheck.checked && songTitle.scrollWidth > songTitle.clientWidth) {
        songTitle.classList.add('scrolling');
        
        // 创建滚动效果
    // 创建滚动效果
    let startPos = 0;
    const contentWidth = songTitle.scrollWidth;
    const containerWidth = songTitle.clientWidth;

    marqueeInterval = setInterval(() => {
      startPos = (startPos - 1) % contentWidth;
      songTitle.style.transform = `translateX(${startPos}px)`;
      
      // 当文字完全滚出视图时，重置位置
      if (Math.abs(startPos) > contentWidth) {
        startPos = containerWidth;
      }
    }, 30);
    }
    }

    // 初始化音频可视化
    function initVisualization() {
    // 创建基本可视化条
    for (let i = 0; i < 16; i++) {
    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.height = '3px';
    visualization.appendChild(bar);
    }

    // 初始化增强版可视化
    initEnhancedViz();
    }

    // 初始化增强版可视化
    function initEnhancedViz() {
    const canvas = vizCanvas;
    canvas.width = enhancedViz.clientWidth;
    canvas.height = enhancedViz.clientHeight;
    canvasContext = canvas.getContext('2d');
    }

    // 更新可视化
    function updateVisualization() {
    if (!audioContext || !analyser || !visualizerCheck.checked) return;

    // 更新基本可视化条
    const bars = document.querySelectorAll('.bar');
    const bufferLength = 32;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteFrequencyData(dataArray);

    const step = Math.floor(bufferLength / bars.length);
    bars.forEach((bar, index) => {
    // 使用 requestAnimationFrame 回调中的值，避免频繁DOM更新
    const value = dataArray[index * step];
    const height = Math.max(3, (value / 255) * 50);
    bar.style.height = `${height}px`;

    // 根据音频强度改变颜色
    const hue = 280 - ((value / 255) * 60);
    bar.style.backgroundColor = `hsl(${hue}, 80%, 60%)`;
    });

    // 更新增强版可视化效果
    updateEnhancedViz(dataArray);

    animationFrame = requestAnimationFrame(updateVisualization);
    }

    // 更新增强版可视化效果
    function updateEnhancedViz(dataArray) {
    if (!canvasContext) return;

    const canvas = vizCanvas;
    const width = canvas.width;
    const height = canvas.height;
    const centerX = width / 2;
    const centerY = height / 2;

    // 清空画布
    canvasContext.clearRect(0, 0, width, height);

    // 获取主题颜色
    const computedStyle = getComputedStyle(document.documentElement);
    const primary = computedStyle.getPropertyValue('--primary').trim();
    const secondary = computedStyle.getPropertyValue('--secondary').trim();

    // 绘制环形可视化
    canvasContext.beginPath();
    canvasContext.arc(centerX, centerY, Math.min(width, height) * 0.3, 0, Math.PI * 2);
    canvasContext.lineWidth = 2;
    canvasContext.strokeStyle = primary;
    canvasContext.stroke();

    // 根据音频数据绘制动态线条
    const barCount = dataArray.length;
    const angleStep = (Math.PI * 2) / barCount;

    for (let i = 0; i < barCount; i++) {
    const value = dataArray[i] / 255;
    const innerRadius = Math.min(width, height) * 0.2;
    const outerRadius = innerRadius + (value * Math.min(width, height) * 0.15);

    const angle = i * angleStep;
    const x1 = centerX + innerRadius * Math.cos(angle);
    const y1 = centerY + innerRadius * Math.sin(angle);
    const x2 = centerX + outerRadius * Math.cos(angle);
    const y2 = centerY + outerRadius * Math.sin(angle);

    // 绘制线条
    canvasContext.beginPath();
    canvasContext.moveTo(x1, y1);
    canvasContext.lineTo(x2, y2);
    canvasContext.lineWidth = 2;
    canvasContext.strokeStyle = `hsla(${280 - (value * 60)}, 80%, 60%, ${value * 0.7})`;
    canvasContext.stroke();

    // 绘制顶点小圆点
    canvasContext.beginPath();
    canvasContext.arc(x2, y2, 3, 0, Math.PI * 2);
    canvasContext.fillStyle = secondary;
    canvasContext.fill();
    }
    }

    // 格式化时间（秒 -> MM:SS）
    function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // 格式化睡眠计时器时间（毫秒 -> HH:MM:SS）
    function formatSleepTime(ms) {
    if (!ms) return "00:00:00";

    const seconds = Math.floor((ms / 1000) % 60);
    const minutes = Math.floor((ms / (1000 * 60)) % 60);
    const hours = Math.floor(ms / (1000 * 60 * 60));

    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // 读取音乐文件
    musicInput.addEventListener("change", function() {
    const file = this.files[0];
    if (file) {
    const url = URL.createObjectURL(file);
    audioPlayer.src = url;

    // 将文件名显示为歌曲标题
    const fileName = file.name.replace(/\.[^/.]+$/, ""); // 移除扩展名
    songTitle.textContent = fileName;
    lyricTitle.textContent = fileName;
    fullscreenTitle.textContent = fileName;
    songArtist.textContent = "本地音乐";
    fullscreenArtist.textContent = "本地音乐";

    // 检查标题是否需要滚动
    checkTitleScroll();

    // 显示通知
    showNotification(`已加载音乐: ${fileName}`);

    // 添加到播放列表
    addToPlaylist(file);

    // 如果需要，初始化音频上下文
    if (!audioContext) {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 64;
        source = audioContext.createMediaElementSource(audioPlayer);
        source.connect(analyser);
        analyser.connect(audioContext.destination);
      } catch (e) {
        console.error('无法创建音频上下文:', e);
        showNotification('音频可视化初始化失败', 3000);
      }
    }

    // 重置进度
    progressSlider.value = 0;
    currentTimeDisplay.textContent = "0:00";

    // 加载后如果启用了自动播放，则自动播放
    audioPlayer.addEventListener("loadedmetadata", function() {
      totalTimeDisplay.textContent = formatTime(audioPlayer.duration);
      fullscreenTotalTime.textContent = formatTime(audioPlayer.duration);
      
      if (autoplayCheck.checked) {
        playAudio();
      }
    });
    }
    });

    // 添加到播放列表
    function addToPlaylist(file) {
    const fileName = file.name.replace(/\.[^/.]+$/, "");
    const fileUrl = URL.createObjectURL(file);

    // 检查是否已存在相同的文件
    const exists = currentPlaylist.some(item => item.name === fileName);

    if (!exists) {
    currentPlaylist.push({
      name: fileName,
      url: fileUrl,
      file: file
    });

    // 更新播放列表显示
    updatePlaylistDisplay();
    }
    }

    // 更新播放列表显示
    function updatePlaylistDisplay() {
    // 清空列表
    playlistItems.innerHTML = '';

    // 填充列表项
    currentPlaylist.forEach((item, index) => {
    const li = document.createElement('li');
    li.className = 'playlist-item';
    if (index === currentTrackIndex) {
      li.classList.add('active');
    }

    li.innerHTML = `
      <span class="playlist-item-title">${item.name}</span>
      <div class="playlist-controls">
        <button class="playlist-btn playlist-play" data-index="${index}"><i class="fas fa-play"></i></button>
        <button class="playlist-btn playlist-remove" data-index="${index}"><i class="fas fa-trash"></i></button>
      </div>
    `;

    // 添加点击播放事件
    const playBtn = li.querySelector('.playlist-play');
    playBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      currentTrackIndex = index;
      loadTrack(index);
      playAudio();
      updatePlaylistDisplay();
    });

    // 添加删除事件
    const removeBtn = li.querySelector('.playlist-remove');
    removeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      removeFromPlaylist(index);
    });

    // 添加整行点击事件
    li.addEventListener('click', () => {
      currentTrackIndex = index;
      loadTrack(index);
      playAudio();
      updatePlaylistDisplay();
    });

    playlistItems.appendChild(li);
    });
    }

    // 从播放列表删除项目
    function removeFromPlaylist(index) {
    // 如果删除的是当前播放的曲目
    if (index === currentTrackIndex) {
    audioPlayer.pause();
    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    fullscreenPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
    }

    // 调整当前播放索引
    if (index < currentTrackIndex) {
    currentTrackIndex--;
    } else if (index === currentTrackIndex && currentPlaylist.length > 1) {
    // 如果删除的是最后一个，则索引调整到最后一个
    if (index === currentPlaylist.length - 1) {
      currentTrackIndex = currentPlaylist.length - 2;
    }
    // 否则保持索引不变，播放下一首
    }

    // 移除项目
    currentPlaylist.splice(index, 1);

    // 如果播放列表为空
    if (currentPlaylist.length === 0) {
    currentTrackIndex = 0;
    }

    // 更新播放列表显示
    updatePlaylistDisplay();
    showNotification('已从播放列表中移除');
    }

    // 加载指定索引的曲目
    function loadTrack(index) {
    if (index >= 0 && index < currentPlaylist.length) {
    const track = currentPlaylist[index];
    audioPlayer.src = track.url;

    // 更新界面
    songTitle.textContent = track.name;
    lyricTitle.textContent = track.name;
    fullscreenTitle.textContent = track.name;
    checkTitleScroll();

    // 重置进度
    progressSlider.value = 0;
    currentTimeDisplay.textContent = "0:00";

    // 加载完成后更新总时长
    audioPlayer.addEventListener("loadedmetadata", function onLoaded() {
      totalTimeDisplay.textContent = formatTime(audioPlayer.duration);
      fullscreenTotalTime.textContent = formatTime(audioPlayer.duration);
      audioPlayer.removeEventListener("loadedmetadata", onLoaded);
    });

    // 更新播放列表激活状态
    updatePlaylistDisplay();
    }
    }

    // 读取封面文件
    coverInput.addEventListener("change", function() {
    const file = this.files[0];
    if (file) {
    const url = URL.createObjectURL(file);
    coverImg.src = url;
    fullscreenCoverImg.src = url;
    coverImg.style.display = "block";
    coverPlaceholder.style.display = "none";

    showNotification("封面已更新");

    // 设置带有模糊效果的背景
    backgroundDiv.style.backgroundImage = `url(${url})`;

    // 计算平均亮度来调整歌词文本颜色
    coverImg.onload = function() {
      computeImageBrightness(coverImg, function(avgBrightness) {
        // 如果平均亮度低（深色封面），使用亮色文本，否则使用深色
        if (avgBrightness < 128) {
          lyricContent.style.color = varColor('--light', '#F8F8FF');
        } else {
          lyricContent.style.color = varColor('--dark', '#1A1A1A');
        }
      });
    }
    }
    });

    // 使用Canvas计算图像平均亮度（优化版本）
    function computeImageBrightness(image, callback) {
    const canvas = document.createElement("canvas");
    // 降低分辨率加快计算速度
    const sampleSize = Math.min(image.naturalWidth, image.naturalHeight, 50);
    canvas.width = sampleSize;
    canvas.height = sampleSize;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(image, 0, 0, sampleSize, sampleSize);

    try {
    const imageData = ctx.getImageData(0, 0, sampleSize, sampleSize);
    let data = imageData.data;
    let colorSum = 0;
    const pixelCount = data.length / 4;

    // 优化循环，每4个元素一次
    for (let i = 0; i < data.length; i += 16) {
      const avg = Math.floor((data[i] + data[i+1] + data[i+2]) / 3);
      colorSum += avg;
    }

    const brightness = Math.floor(colorSum / (pixelCount / 4));
    callback(brightness);
    } catch (e) {
    // 如果出现错误（例如，CORS问题），默认使用亮色文本
    console.error('计算亮度时出错：', e);
    callback(0);
    }
    }

    // 获取CSS变量值（带有后备值）
    function varColor(name, def) {
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || def;
    }

    // 读取带编码检测的歌词文件
    lyricInput.addEventListener("change", function() {
    const file = this.files[0];
    if (file) {
    const reader = new FileReader();
    // 首先尝试GBK编码（中文歌词常用）
    reader.readAsText(file, "GBK");
    reader.onload = function(e) {
      parseLyrics(e.target.result);
      // 如果解析失败或导致乱码，尝试UTF-8
      if (lyrics.length === 0 || lyrics.some(line => /�/.test(line.text))) {
        const reader2 = new FileReader();
        reader2.readAsText(file, "UTF-8");
        reader2.onload = function(e) {
          parseLyrics(e.target.result);
          showNotification("歌词已加载");
        };
      } else {
        showNotification("歌词已加载");
      }
    };
    reader.onerror = function() {
      showNotification("文件读取错误，请检查文件编码格式", 5000);
    };
    }
    });

    // 播放音频函数
    function playAudio() {
    if (audioContext && audioContext.state === 'suspended') {
    audioContext.resume();
    }

    audioPlayer.play()
    .then(() => {
      playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      fullscreenPlayBtn.innerHTML = '<i class="fas fa-pause"></i>';
      updateVisualization();
    })
    .catch(err => {
      console.error("播放失败:", err);
      showNotification("播放失败，请先选择音乐文件", 5000);
    });
    }

    // 暂停音频函数
    function pauseAudio() {
    audioPlayer.pause();
    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    fullscreenPlayBtn.innerHTML = '<i class="fas fa-play"></i>';
    cancelAnimationFrame(animationFrame);
    }

    // 播放/暂停按钮
    playPauseBtn.addEventListener("click", () => {
    if (audioPlayer.paused) {
    playAudio();
    } else {
    pauseAudio();
    }
    });

    // 上一曲按钮
    prevBtn.addEventListener("click", () => {
    if (currentPlaylist.length > 1) {
    currentTrackIndex = (currentTrackIndex - 1 + currentPlaylist.length) % currentPlaylist.length;
    loadTrack(currentTrackIndex);
    playAudio();
    } else {
    // 如果只有一首歌，重新开始
    audioPlayer.currentTime = 0;
    }
    });

    // 下一曲按钮
    nextBtn.addEventListener("click", () => {
    if (currentPlaylist.length > 1) {
    currentTrackIndex = (currentTrackIndex + 1) % currentPlaylist.length;
    loadTrack(currentTrackIndex);
    playAudio();
    } else {
    // 如果只有一首歌，前进10秒
    audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 10, audioPlayer.duration || 0);
    }
    });

    // 重复播放按钮
    repeatBtn.addEventListener("click", () => {
    repeatMode = (repeatMode + 1) % 3; // 循环：0(不重复) -> 1(单曲) -> 2(列表) -> 0

    switch(repeatMode) {
    case 0: // 不重复
      repeatBtn.innerHTML = '<i class="fas fa-repeat"></i>';
      repeatBtn.classList.remove('active', 'repeat-one');
      showNotification("重复播放：关闭");
      break;
    case 1: // 单曲循环
      repeatBtn.innerHTML = '<i class="fas fa-repeat"></i>';
      repeatBtn.classList.add('active', 'repeat-one');
      showNotification("重复播放：单曲循环");
      break;
    case 2: // 列表循环
      repeatBtn.innerHTML = '<i class="fas fa-redo-alt"></i>';
      repeatBtn.classList.add('active');
      repeatBtn.classList.remove('repeat-one');
      showNotification("重复播放：列表循环");
      break;
    }
    });

    // 睡眠定时按钮
    sleepBtn.addEventListener("click", () => {
    sleepTimerModal.style.display = 'flex';
    });

    // 处理睡眠选项点击
    sleepOptions.forEach(option => {
    option.addEventListener('click', () => {
    // 移除其他活动选项
    sleepOptions.forEach(opt => opt.classList.remove('active'));
    // 激活当前选项
    option.classList.add('active');
    // 设置分钟数
    sleepTimerMinutes = parseInt(option.dataset.minutes);
    });
    });

    // 确认睡眠定时
    confirmSleepTimer.addEventListener('click', () => {
    if (sleepTimerMinutes > 0) {
    // 计算结束时间
    sleepTimerEnd = Date.now() + (sleepTimerMinutes * 60 * 1000);

    // 更新显示并开始倒计时
    updateSleepTimerDisplay();

    // 设置定时器
    sleepTimerInterval = setInterval(() => {
      updateSleepTimerDisplay();
      
      // 检查是否到达结束时间
      if (Date.now() >= sleepTimerEnd) {
        pauseAudio();
        clearInterval(sleepTimerInterval);
        sleepTimerEnd = null;
        sleepBtn.classList.remove('active');
        showNotification('睡眠定时结束，音乐已暂停');
      }
    }, 1000);

    // 激活睡眠按钮
    sleepBtn.classList.add('active');
    showNotification(`睡眠定时已设置：${sleepTimerMinutes}分钟后停止播放`);

    // 关闭模态窗口
    sleepTimerModal.style.display = 'none';
    } else {
    showNotification('请选择时间');
    }
    });

    // 取消睡眠定时
    cancelSleepTimer.addEventListener('click', () => {
    // 清除定时器
    clearInterval(sleepTimerInterval);
    sleepTimerEnd = null;
    sleepBtn.classList.remove('active');

    // 关闭模态窗口
    sleepTimerModal.style.display = 'none';

    // 如果之前有设置过，显示通知
    if (sleepTimerInterval) {
    showNotification('睡眠定时已取消');
    }
    });

    // 点击睡眠定时模态窗口外部关闭
    sleepTimerModal.addEventListener('click', (e) => {
    if (e.target === sleepTimerModal) {
    sleepTimerModal.style.display = 'none';
    }
    });

    // 更新睡眠定时器显示
    function updateSleepTimerDisplay() {
    if (sleepTimerEnd) {
    const remaining = sleepTimerEnd - Date.now();
    if (remaining > 0) {
      timerDisplay.textContent = formatSleepTime(remaining);
    } else {
      timerDisplay.textContent = "00:00:00";
    }
    } else {
    timerDisplay.textContent = "00:00:00";
    }
    }

    // 全屏模式按钮
    fullscreenBtn.addEventListener('click', () => {
    toggleFullscreen();
    });

    // 切换全屏模式
    function toggleFullscreen() {
    isFullscreen = !isFullscreen;

    if (isFullscreen) {
    fullscreenMode.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // 更新全屏界面
    updateFullscreenUI();
    } else {
    fullscreenMode.style.display = 'none';
    document.body.style.overflow = '';
    }
    }

    // 更新全屏界面
    function updateFullscreenUI() {
    // 同步封面
    if (coverImg.style.display !== 'none') {
    fullscreenCoverImg.src = coverImg.src;
    } else {
    // 使用默认封面背景
    fullscreenCoverImg.src = '';
    fullscreenCoverImg.style.background = 'linear-gradient(45deg, #37529d, #55d3b6)';
    }

    // 同步播放状态
    fullscreenPlayBtn.innerHTML = audioPlayer.paused ? 
    '<i class="fas fa-play"></i>' : 
    '<i class="fas fa-pause"></i>';

    // 同步标题和艺术家
    fullscreenTitle.textContent = songTitle.textContent;
    fullscreenArtist.textContent = songArtist.textContent;
    }

    // 关闭全屏按钮
    closeFullscreen.addEventListener('click', () => {
    toggleFullscreen();
    });

    // 全屏播放/暂停按钮
    fullscreenPlayBtn.addEventListener('click', () => {
    if (audioPlayer.paused) {
    playAudio();
    } else {
    pauseAudio();
    }
    });

    // 全屏上一曲按钮
    fullscreenPrevBtn.addEventListener('click', () => {
    prevBtn.click();
    });

    // 全屏下一曲按钮
    fullscreenNextBtn.addEventListener('click', () => {
    nextBtn.click();
    });

    // 全屏进度条点击
    fullscreenProgressBar.addEventListener('click', (e) => {
    const rect = fullscreenProgressBar.getBoundingClientRect();
    const ratio = (e.clientX - rect.left) / rect.width;

    if (audioPlayer.duration) {
    audioPlayer.currentTime = ratio * audioPlayer.duration;
    }
    });

    // 播放列表按钮
    playlistBtn.addEventListener('click', () => {
    playlistModal.style.display = 'flex';
    updatePlaylistDisplay();
    });

    // 关闭播放列表
    closePlaylist.addEventListener('click', () => {
    playlistModal.style.display = 'none';
    });

    // 点击播放列表模态窗口外部关闭
    playlistModal.addEventListener('click', (e) => {
    if (e.target === playlistModal) {
    playlistModal.style.display = 'none';
    }
    });

    // 添加到播放列表按钮
    addPlaylistBtn.addEventListener('click', () => {
    musicInput.click();
    });

    // 更新进度条和时间显示
    audioPlayer.addEventListener("timeupdate", () => {
    if (audioPlayer.duration) {
    const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressSlider.value = percent;
    currentTimeDisplay.textContent = formatTime(audioPlayer.currentTime);

    // 更新全屏进度条
    fullscreenProgressCurrent.style.width = `${percent}%`;
    fullscreenCurrentTime.textContent = formatTime(audioPlayer.currentTime);
    }

    // 更新歌词高亮
    updateLyricHighlight();
    });

    // 进度滑块交互
    progressSlider.addEventListener("input", () => {
    if (audioPlayer.duration) {
    const newTime = (progressSlider.value / 100) * audioPlayer.duration;
    audioPlayer.currentTime = newTime;
    currentTimeDisplay.textContent = formatTime(newTime);
    }
    });

    // 音量控制
    volumeSlider.addEventListener("input", () => {
    const volume = volumeSlider.value / 100;
    audioPlayer.volume = volume;
    state.volume = volume;

    // 根据音量级别更新音量图标
    updateVolumeIcon(volume);
    });

    // 更新音量图标
    function updateVolumeIcon(volume) {
    if (volume === 0) {
    volumeIcon.className = "fas fa-volume-mute";
    } else if (volume < 0.5) {
    volumeIcon.className = "fas fa-volume-down";
    } else {
    volumeIcon.className = "fas fa-volume-up";
    }
    }

    // 点击音量图标静音/取消静音
    volumeIcon.addEventListener("click", () => {
    if (audioPlayer.volume > 0) {
    audioPlayer.oldVolume = audioPlayer.volume;
    audioPlayer.volume = 0;
    volumeSlider.value = 0;
    volumeIcon.className = "fas fa-volume-mute";
    } else {
    audioPlayer.volume = audioPlayer.oldVolume || 0.8;
    volumeSlider.value = audioPlayer.volume * 100;
    updateVolumeIcon(audioPlayer.volume);
    }
    });

    // 曲目结束事件
    audioPlayer.addEventListener("ended", () => {
    // 根据重复模式处理
    switch(repeatMode) {
    case 0: // 不重复
      if (currentPlaylist.length > 1 && currentTrackIndex < currentPlaylist.length - 1) {
        // 播放下一首
        currentTrackIndex++;
        loadTrack(currentTrackIndex);
        playAudio();
      } else {
        pauseAudio();
      }
      break;
    case 1: // 单曲循环
      audioPlayer.currentTime = 0;
      playAudio();
      break;
    case 2: // 列表循环
      if (currentPlaylist.length > 1) {
        currentTrackIndex = (currentTrackIndex + 1) % currentPlaylist.length;
        loadTrack(currentTrackIndex);
        playAudio();
      } else {
        // 只有一首歌，重新播放
        audioPlayer.currentTime = 0;
        playAudio();
      }
      break;
    }
    });

    // 点击封面显示歌词覆盖层
    cover.addEventListener("click", () => {
    showLyrics();
    });

    // 显示歌词函数
    function showLyrics() {
    lyricOverlay.style.display = "flex";
    lyricOverlay.style.opacity = 0;

    // 使用setTimeout确保过渡效果正常
    setTimeout(() => {
    lyricOverlay.style.opacity = 1;
    }, 10);
    }

    // 关闭歌词按钮
    closeLyrics.addEventListener("click", () => {
    hideLyrics();
    });

    // 隐藏歌词函数
    function hideLyrics() {
    lyricOverlay.style.opacity = 0;
    setTimeout(() => {
    lyricOverlay.style.display = "none";
    }, 300);
    }

    // 点击歌词内容外部关闭
    lyricOverlay.addEventListener("click", (e) => {
    if (e.target === lyricOverlay) {
    hideLyrics();
    }
    });

    // 解析LRC格式歌词（优化版本）
    function parseLyrics(text) {
    lyrics = [];
    const lines = text.split('\n');
    const timeExp = /\[(\d{2}):(\d{2})(\.\d{2,3})?\]/g;

    lines.forEach(line => {
    let match;
    const timeMatches = [];

    // 收集一行中的所有时间标记
    while ((match = timeExp.exec(line)) !== null) {
      const minutes = parseInt(match[1]);
      const seconds = parseInt(match[2]);
      const millis = match[3] ? parseFloat(match[3]) : 0;
      const time = minutes * 60 + seconds + millis;
      timeMatches.push({time, index: match.index, length: match[0].length});
    }

    // 如果有时间标记
    if (timeMatches.length > 0) {
      // 提取歌词文本（去掉所有时间标记）
      let lyricText = line;
      for (let i = timeMatches.length - 1; i >= 0; i--) {
        lyricText = lyricText.substring(0, timeMatches[i].index) + 
                    lyricText.substring(timeMatches[i].index + timeMatches[i].length);
      }
      lyricText = lyricText.trim();
      
      // 为每个时间标记添加相同的歌词
      if (lyricText) {
        timeMatches.forEach(tm => {
          lyrics.push({time: tm.time, text: lyricText});
        });
      }
    }
    });

    // 按时间排序
    lyrics.sort((a, b) => a.time - b.time);
    renderLyrics();
    }

    // 将歌词渲染到歌词内容区域（优化版本）
    function renderLyrics() {
    // 保留标题，删除其余部分
    const header = lyricContent.querySelector('.lyric-header');
    lyricContent.innerHTML = '';
    lyricContent.appendChild(header);

    if (lyrics.length === 0) {
    const div = document.createElement("div");
    div.className = "lyric-line";
    div.textContent = "未找到歌词或格式不正确";
    lyricContent.appendChild(div);
    return;
    }

    // 使用DocumentFragment优化性能
    const fragment = document.createDocumentFragment();

    lyrics.forEach((line, index) => {
    const div = document.createElement("div");
    div.className = "lyric-line";
    div.dataset.time = line.time;
    div.dataset.index = index;
    div.textContent = line.text || "♪";

    div.addEventListener("click", () => {
      audioPlayer.currentTime = line.time;
      if (audioPlayer.paused) {
        playAudio();
      }
    });

    fragment.appendChild(div);
    });

    lyricContent.appendChild(fragment);
    }

    // 如果用户手动滚动，阻止自动滚动
    lyricContent.addEventListener("scroll", () => {
    autoScroll = false;
    clearTimeout(autoScrollTimeout);
    autoScrollTimeout = setTimeout(() => {
    autoScroll = true;
    }, 5000); // 5秒后恢复自动滚动
    });

    // 根据播放时间突出显示当前歌词（优化版本）
    function updateLyricHighlight() {
    const currentTime = audioPlayer.currentTime;
    let activeIndex = -1;

    // 使用二分查找找到当前歌词行（优化性能）
    let left = 0;
    let right = lyrics.length - 1;

    while (left <= right) {
    const mid = Math.floor((left + right) / 2);
    if (lyrics[mid].time <= currentTime) {
      activeIndex = mid;
      left = mid + 1;
    } else {
      right = mid - 1;
    }
    }

    // 更新歌词行类
    const lyricLines = document.querySelectorAll(".lyric-line");
    if (!lyricLines.length) return;

    // 使用requestAnimationFrame优化性能
    requestAnimationFrame(() => {
    let activeElement = null;

    lyricLines.forEach((line) => {
      if (line.dataset.index === undefined) return; // 如果不是歌词行（例如标题），则跳过
      
      const lineIndex = parseInt(line.dataset.index);
      if (lineIndex === activeIndex) {
        line.classList.add("active");
        activeElement = line;
      } else {
        line.classList.remove("active");
      }
    });

    // 如果激活了某行歌词并且允许自动滚动
    if (activeElement && autoScroll) {
      const containerHeight = lyricContent.clientHeight;
      const lineTop = activeElement.offsetTop;
      const lineHeight = activeElement.clientHeight;
      const scrollTo = lineTop - (containerHeight - lineHeight) / 2;
      
      lyricContent.scrollTo({
        top: scrollTo,
        behavior: 'smooth'
      });
    }
    });
    }

    // 调整视窗大小时的处理（优化性能）
    let resizeTimeout;
    window.addEventListener('resize', () => {
    // 使用防抖优化性能
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
    // 重新初始化增强版可视化
    if (vizCanvas) {
      vizCanvas.width = enhancedViz.clientWidth;
      vizCanvas.height = enhancedViz.clientHeight;
    }

    // 重新检查标题滚动
    checkTitleScroll();
    }, 200);
    });

    // 页面加载时初始化
    window.addEventListener('load', () => {
    // 设置初始音量
    audioPlayer.volume = state.volume;
    volumeSlider.value = state.volume * 100;
    updateVolumeIcon(state.volume);

    // 创建可视化条
    initVisualization();

    // 欢迎通知
    setTimeout(() => {
    showNotification("欢迎使用现代音乐播放器", 5000);
    }, 1000);

    // 启用键盘控制
    document.addEventListener('keydown', (e) => {
    // 避免在输入框内触发
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }

    switch (e.code) {
      case 'Space':
        e.preventDefault(); // 防止按空格键时页面滚动
        if (audioPlayer.paused) {
          playAudio();
        } else {
          pauseAudio();
        }
        break;
      case 'ArrowRight':
        e.preventDefault();
        audioPlayer.currentTime += 5; // 向前跳过5秒
        break;
      case 'ArrowLeft':
        e.preventDefault();
        audioPlayer.currentTime -= 5; // 向后跳过5秒
        break;
      case 'ArrowUp':
        e.preventDefault();
        volumeSlider.value = Math.min(100, parseInt(volumeSlider.value) + 5);
        audioPlayer.volume = volumeSlider.value / 100;
        state.volume = audioPlayer.volume;
        updateVolumeIcon(audioPlayer.volume);
        break;
      case 'ArrowDown':
        e.preventDefault();
        volumeSlider.value = Math.max(0, parseInt(volumeSlider.value) - 5);
        audioPlayer.volume = volumeSlider.value / 100;
        state.volume = audioPlayer.volume;
        updateVolumeIcon(audioPlayer.volume);
        break;
      case 'KeyR':
        // 快捷键R切换重复模式
        repeatBtn.click();
        break;
      case 'KeyF':
        // 快捷键F切换全屏模式
        toggleFullscreen();
        break;
      case 'KeyL':
        // 快捷键L显示歌词
        showLyrics();
        break;
      case 'KeyP':
        // 快捷键P显示播放列表
        playlistBtn.click();
        break;
      case 'KeyS':
        // 快捷键S显示睡眠定时
        sleepBtn.click();
        break;
      case 'KeyM':
        // 快捷键M切换迷你模式
        toggleMiniPlayer.click();
        break;
      case 'Escape':
        // ESC键关闭所有模态窗口
        hideLyrics();
        playlistModal.style.display = 'none';
        sleepTimerModal.style.display = 'none';
        if (isFullscreen) toggleFullscreen();
        break;
    }
    });
    });

    // 在页面卸载前保存设置
    window.addEventListener('beforeunload', () => {
    saveCurrentSettings();
    });
    </script>
